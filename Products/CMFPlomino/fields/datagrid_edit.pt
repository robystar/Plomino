<tal:block
        define="field python:options['field'];
            fieldname python:options['fieldname'];
            request field/REQUEST;
            v options/fieldvalue;
            data python:field.getSettings().tojson(v);
            need_ajax python:field.id not in request and 'rendered' in v and len(v['rendered']) > 10;
            sAjaxSource string:'sAjaxSource': 'tojson?item=${fieldname}&rendered=true&datatables=true','sServerMethod': 'GET',;
            sAjaxSource python:sAjaxSource if need_ajax else '';
            bServerSide python:'true' if not need_ajax else 'false';
            rendered_data python:field.getSettings().tojson(v, rendered=True) if not need_ajax else '[]';
            form field/getParentNode;
            form_name form/id;
            form_url python:form.absolute_url();
            form_method form/getFormMethod;
            associated_form python:field.getSettings().getAssociateForm();
            associated_form_url python:associated_form and associated_form.absolute_url();
            associated_form_rendering python:field.getSettings().associated_form_rendering;
            new_fields python:field.getSettings().getRenderedFields(creation=True,request=request);
            is_grid python:associated_form_rendering != 'REPEATING';
            ">

    <tal:block tal:condition="is_grid">

        <input type='hidden'
               tal:attributes="
            id string:${fieldname}_gridvalue;
            name fieldname;
            value data"/>
        <script
                type="text/javascript"
                charset="utf-8"
                tal:define="
                param python:field.getSettings().getParameters();
                "
                tal:content="structure string:
                var ${fieldname}_datatable;
                jQuery(document).ready(function() {
                    ${fieldname}_datatable = jQuery('#${fieldname}_datagrid').dataTable( {
                        ${sAjaxSource}
                        'aaData': ${rendered_data}, //use this if field.id is in request (ie we there is an error on page)
                        'bJQueryUI': true,
                        ${param},
                        'fnDrawCallback': function() {
                            jQuery('#${fieldname}_datagrid > tbody > tr').click(function() {
                                datagrid_deselect_rows(${fieldname}_datatable);
                                jQuery(this).addClass('datagrid_row_selected');
                            });
                        },
                        'oLanguage': {
                            'sUrl': '@@collective.js.datatables.translation'
                        }
                    } );
                    /**
                        INLINE EDITING MODE
                    **/
                    if('${associated_form_rendering}'==='INLINE') {

                        var ${fieldname}_nEditing = null;

                        /** Add inline creation form **/
                        jQuery('#${fieldname}_addrow').click( function (e) {
                            e.preventDefault();
                            ${fieldname}_nEditing = datagrid_add_inline_row( ${fieldname}_datatable,  ${new_fields} )
                        } );

                        /** Compute inline form **/
                        function ${fieldname}_computeEdit(event){
                            event.preventDefault();
                            if ( ${fieldname}_nEditing!=null ) {
                                datagrid_restore_row(${fieldname}_datatable, ${fieldname}_nEditing);
                            }
                            var url = '${form_url}/${fieldname}/editFields?';
                            ${fieldname}_nEditing = datagrid_edit_inline_form(${fieldname}_datatable,'${fieldname}',url);
                        }

                        jQuery('#${fieldname}_editrow').click(${fieldname}_computeEdit);
                        jQuery('#${fieldname}_datagrid tbody>tr').live('dblclick', ${fieldname}_computeEdit);

                        /** Save changes **/
                        jQuery('#${fieldname}_datagrid button.save').live('click', function (e) {
                            e.preventDefault();
                            var nRow = $(this).parents('tr')[0];
                            var url = '${associated_form_url}/createDocument?Plomino_Parent_Field=${fieldname}&Plomino_Parent_Form=${form_name}';

                            if ( ${fieldname}_nEditing == nRow ) {
                                var succeeded = datagrid_save_inline_row( ${fieldname}_datatable, ${fieldname}_nEditing,'${fieldname}',url);
                                if(succeeded===true)
                                    ${fieldname}_nEditing = null;
                            }
                        } );

                        /** Cancel edition **/
                        jQuery('#${fieldname}_datagrid button.cancel').live('click', function (e) {
                            e.preventDefault();
                            var nRow = $(this).parents('tr')[0];
                            datagrid_restore_row(${fieldname}_datatable, nRow);
                            ${fieldname}_nEditing = null;
                        });
                    }
                    /**
                        MODAL MODE
                    **/
                    else{

                        jQuery('#${fieldname}_addrow').click(function() {
                            datagrid_add_row(${fieldname}_datatable, '${fieldname}', this.href);
                        });
                        jQuery('#${fieldname}_editrow').click(function() {
                            datagrid_edit_row(${fieldname}_datatable, '${fieldname}', this.href);
                        });
                        jQuery('#${fieldname}_editform').dialog({ 'autoOpen': false, 'modal': true });
                    }

                    jQuery('#${fieldname}_deleterow').click(function() {
                        datagrid_delete_row(${fieldname}_datatable, '${fieldname}');
                    });

                    /** Code for hiding repeating subforms **/


                } );">
        </script>

        <table class="display" tal:attributes="id string:${fieldname}_datagrid">
        </table>
        <div tal:attributes="id string:${fieldname}_editform"></div>
        <p><a class="context add-row"
              tal:condition="associated_form"
              tal:attributes="id string:${fieldname}_addrow;
                          href string:${associated_form_url}/OpenBareForm?Plomino_Parent_Field=${fieldname}&Plomino_Parent_Form=${form_name};
                          onclick string:event.preventDefault ? event.preventDefault() : event.returnValue = false;; return false"
              tal:content="python:options['field'].getSettings().getActionLabel('add')"
                >Add row</a>
            <a class="context edit-row"
               tal:condition="associated_form"
               tal:attributes="id string:${fieldname}_editrow;
                          href string:${associated_form_url}/OpenBareForm?Plomino_Parent_Field=${fieldname}&Plomino_Parent_Form=${form_name};
                          onclick string:event.preventDefault ? event.preventDefault() : event.returnValue = false;; return false;
                          style python:{0: 'display:none'}.get(len(v), '')"
               tal:content="python:options['field'].getSettings().getActionLabel('edit')"
                    >Edit row</a>
            <a href="javascript:void(0)" class="context delete-row"
               tal:attributes="id string:${fieldname}_deleterow;
                          onclick string:event.preventDefault ? event.preventDefault() : event.returnValue = false;; return false;
                          style python:{0: 'display:none'}.get(len(v), '')"
               tal:content="python:options['field'].getSettings().getActionLabel('delete')"
                    >Delete row</a>
        </p>
    </tal:block>


    <tal:block tal:condition="not:is_grid"
               define="subforms python:list(field.getSettings().toSubforms(v, options['doc'], editmode=True));
               row_count python:len(field.getSettings().rows(v))">
        <input type="hidden"
               tal:attributes="name string:${fieldname}.datagrid-stupid-zope-reset:records;"
               value="1"/>
        <tal:block tal:repeat="subform subforms">

            <div tal:define="index repeat/subform/index;
                            show python:index == 0 or index < row_count;
                            show_next python: index < row_count-1"
                 tal:attributes="id string:repeat-${fieldname}-${index};
                                 style python:'display:none' if not show else ''">
                <fieldset aria-hidden="false"
                        tal:attributes="aria-hidden not:show">
                    <legend tal:content="string:${fieldname} ${repeat/subform/number}"></legend>
                    <tal:block tal:replace="structure subform"/>

                </fieldset>
                <input type="hidden"
                       tal:attributes="name string:${fieldname}.datagrid-stupid-zope-reset:records;"
                       value="1"/>
                <fieldset tal:condition="not:repeat/subform/end"
                          tal:define="i repeat/subform/number; next python:i+1">
                    <legend>Include another
                        <tal:replace replace="string: ${fieldname}"/>
                    </legend>
                    <label><input type="radio"
                                  name="address.datagrid-include-1:records"
                                  value="yes" data-target="repeat-address-2"
                                  tal:attributes="name string:${fieldname}.datagrid-include-${i}:records;
                          data-target string:repeat-${fieldname}-${i};
                          onclick string:jQuery('#repeat-${fieldname}-${i}').show();
                          checked show_next"
                            />Yes</label>
                    <label><input type="radio"
                                  name="address.__include__:records"
                                  tal:attributes="name string:${fieldname}.datagrid-include-${i}:records; id string:${fieldname}-datagridinclude-${i};
                          onclick string:jQuery('input#${fieldname}-datagridinclude-${next}').click();; jQuery('#repeat-${fieldname}-${i}').hide();
                          checked not:show_next" value="" checked/>No</label>
                          <!--onclick string:for(var n = ${i};; n < ${repeat/subform/length};; n++) jQuery('#repeat-${fieldname}-'+n).hide();-->
                </fieldset>
            </div>
        </tal:block>

    </tal:block>

</tal:block>
